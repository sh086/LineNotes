# 通过接口运维数据库

## 编写代码

### Mapper

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shooter.module.api.mapper.DbDao">
    <insert id="insert" parameterType="java.lang.String">
        ${value}
    </insert>

    <select id="selectList" parameterType="java.lang.String" resultType="java.util.HashMap" useCache="false">
        ${value}
    </select>

    <select id="selectOne" parameterType="java.lang.String" resultType="java.util.HashMap" useCache="false">
        ${value}
    </select>

    <delete id="selectCount" parameterType="java.lang.String">
        ${value}
    </delete>

    <delete id="delete" parameterType="java.lang.String">
        ${value}
    </delete>

    <update id="update" parameterType="java.lang.String">
        ${value}
    </update>
</mapper>
```



### Dao

```java
package com.shooter.module.api.mapper;

import java.util.List;
import java.util.Map;

public interface DbDao {

    int insert(String sql);

    List selectList(String sql);

    int selectCount(String sql);

    Map selectOne(String sql);

    int delete(String sql);

    int update(String sql);

}
```



### Controller

```java
@PostMapping("/maintenanceApi")
@ResponseBody
public ResultObjectModel maintenanceApi(@RequestBody JSONObject request){
    val result = new ResultObjectModel();
    try{
        val key = request.getString("key");
        val secret = "hcisc.bhb@801Qw-" + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd"));
        val tag = request.getString("tag");
        val sql = request.getString("sql");
        Object obj;
        if(secret.equals(key) && StringUtils.isNotBlank(sql) && StringUtils.isNotBlank(tag)){
            //限制不能使用的语句
            val flag1 = sql.toUpperCase().contains("TRUNCATE")
                || sql.toUpperCase().contains("DROP");
            //删除和更新必须带where条件
            val flag2 = sql.toUpperCase().contains("DELETE") && !sql.toUpperCase().contains("WHERE");
            val flag3 = sql.toUpperCase().contains("UPDATE") && !sql.toUpperCase().contains("WHERE");
            if(flag2 || flag3){
                throw new BusinessException("无法执行的语句！");
            }
            switch(tag){
                case "insert" :  obj = dbDao.insert(sql); break;
                case "selectList" : obj = dbDao.selectList(sql); break;
                case "selectOne" :obj =  dbDao.selectOne(sql); break;
                case "selectCount" :obj =  dbDao.selectCount(sql); break;
                case "delete" : obj = dbDao.delete(sql); break;
                case "update" : obj = dbDao.update(sql); break;
                default : throw new BusinessException("未能识别的TAG！");
            }
        }else {
            throw new BusinessException("密钥错误！");
        }
        result.setResult(true);
        result.setData(obj);
        result.setMessage("查询成功");
    }catch (Exception e){
        result.setResult(false);
        result.setMessage("查询失败：" + e.getMessage());
    }
    return result;
}
```



## 测试用例

```java
package com.shooter.moudle;
import com.alibaba.fastjson.JSONObject;
import com.shooter.Application;
import com.shooter.module.api.mapper.DbDao;
import lombok.extern.slf4j.Slf4j;
import lombok.val;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;
import javax.annotation.Resource;
import java.util.List;
import java.util.Map;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
@Slf4j
public class MybatisSqlTest {

    @Resource
    private DbDao dbDao;

    // 单个查询
    @Test
    public void testMybatisSelectOne() {
        String sql = "SELECT * from tc_user where userName='小米'";
        val map = dbDao.selectOne(sql);
        log.info("单个查询：{}",JSONObject.toJSONString(map));
    }

    // 多个查询
    @Test
    public void testMybatisSelectList() {
        String sql = "SELECT * from tc_user where userName like '%张%'";
        List list = dbDao.selectList(sql);
        log.info("多个查询：{}", JSONObject.toJSONString(list));
    }

    // 插入
    @Test
    public void testMybatisDeleteInsert() {
        String insertSql = "insert into tc_user (user_name) VALUES('小米');";
        dbDao.insert(insertSql);
        log.info("插入数据：");
    }

    // 更新
    @Test
    public void testMybatisDeleteUpdate() {
        String deleteSql = "update tc_user set user_name = '小米' WHERE id = 10;";
        int n = dbDao.update(deleteSql);
        log.info("更新数据：" + n);
    }

    // 删除
    @Test
    public void testMybatisDeleteRemove() {
        String deleteSql = "delete from tc_user WHERE id = 10;";
        int n = dbDao.delete(deleteSql);
        log.info("删除数据：" + n);
    }
}
```

